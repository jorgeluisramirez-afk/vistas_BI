CREATE OR REPLACE TABLE
  `rs-prd-dlk-sbx-digt-d12c.desa_visualizacion.vista_canal_multiproducto_venta_digital` AS
WITH contable_digital AS (
  SELECT
    periodo,
    num_poliza,
    id_producto,
    'digital' AS marca
  FROM
    `rs-prd-dlk-sbx-digt-d12c.desa_visualizacion.mig_rs_contable_detalle_digital`
  WHERE
    vta_nueva_stock = 'VENTA NUEVA'
    AND periodo >= '2025-01-01'
    AND cont_dig_filtro = 1
  QUALIFY
    ROW_NUMBER() OVER (PARTITION BY num_poliza, id_producto ORDER BY fec_procesamiento DESC) = 1
)

SELECT
  v.periodo,
  v.des_producto,
  v.id_producto,
  producto_forecast_agrup,
  SUM(mnt_prima_contable_usd) AS prima,
  SUM(CASE WHEN marca IS NOT NULL THEN mnt_prima_contable_usd ELSE 0 END) AS prima_digital,
  COUNT(DISTINCT v.num_poliza) AS total_polizas,
  COUNT(DISTINCT CASE WHEN marca IS NOT NULL THEN v.num_poliza END) AS polizas_digital
FROM
  `rs-shr-al-analyticsz-prj-ebc1.anl_produccion.produccion_resumen` v
LEFT JOIN
  `rs-prd-dlk-sbx-digt-d12c.desa_ingesta.de_rs_maestro_prodcontable2` p2
  ON v.id_producto = 'AX-' || p2.codprod
LEFT JOIN
  `rs-prd-dlk-sbx-digt-d12c.desa_ingesta.de_rs_db_ventas_t_producto_fam` d1
  ON d1.producto_agrup = p2.agrup
LEFT JOIN
  contable_digital c
  ON v.num_poliza = c.num_poliza
     AND v.id_producto = c.id_producto
     AND v.periodo = c.periodo
WHERE
  v.periodo BETWEEN '2025-01-01' AND '2025-06-01'
  AND pol_des_canal = 'FUERZA DE VENTA'
  AND pol_des_subcanal IN (
    'FFVV VIDA',
    'FFVV MULTISEGUROS',
    'FFVV SALUD',
    'VIDA DIGITAL',
    'WEB VIDA'
  )
  AND vta_nueva_stock = 'VENTA NUEVA'
GROUP BY
  v.periodo,
  v.des_producto,
  v.id_producto,
  producto_forecast_agrup;
